# Build Stage - Alpine Maven image doesn't include Node.js, so we use standard
FROM maven:3.9-eclipse-temurin-17 AS build
WORKDIR /app

# Copy only POM files first for better layer caching
COPY pom.xml .
COPY api/pom.xml api/
COPY core/pom.xml core/
COPY ui/pom.xml ui/

# Download dependencies (cached if POMs don't change)
RUN mvn dependency:go-offline -pl ui -am || true

# Copy source code
COPY ui/src ui/src
COPY core/src core/src

# Build with production profile (compiles Vaadin frontend)
RUN mvn clean package -DskipTests -pl ui -am

# Runtime Stage - Modern JRE Alpine (smaller and more secure)
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# Copy only the JAR from build stage
COPY --from=build /app/ui/target/mnemonics-ui.jar /app/mnemonics-ui.jar

# Security: Run as non-root user
RUN addgroup -S spring && adduser -S spring -G spring
USER spring:spring

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app/mnemonics-ui.jar"]